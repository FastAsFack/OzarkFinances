{% extends "base.html" %}

{% block title %}Debt Management - Ozark Finances{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <h1 class="mb-4">
            <i class="fas fa-credit-card me-2"></i>Debt Management
        </h1>
        
        <!-- Quick Action Buttons -->
        <div class="mb-3">
            <a href="{{ url_for('debt_analytics') }}" class="btn btn-info me-2">
                <i class="fas fa-chart-line me-1"></i>Analytics
            </a>
            <a href="{{ url_for('debt_report') }}" class="btn btn-secondary me-2">
                <i class="fas fa-file-alt me-1"></i>Report
            </a>
            <button type="button" class="btn btn-warning me-2" data-bs-toggle="modal" data-bs-target="#bulkPaymentModal">
                <i class="fas fa-money-bill-wave me-1"></i>Bulk Payment
            </button>
            <button type="button" class="btn btn-success" data-bs-toggle="modal" data-bs-target="#exportModal">
                <i class="fas fa-download me-1"></i>Export
            </button>
        </div>
    </div>
</div>

<!-- Filter and Sort Controls -->
<div class="row mb-4">
    <div class="col-lg-12">
        <div class="card">
            <div class="card-header">
                <h6 class="mb-0"><i class="fas fa-filter me-2"></i>Filter & Sort</h6>
            </div>
            <div class="card-body">
                <form method="GET" class="row g-3">
                    <div class="col-md-3">
                        <label for="category" class="form-label">Category</label>
                        <select class="form-select" name="category" id="category">
                            <option value="">All Categories</option>
                            {% for category in categories %}
                            <option value="{{ category }}" {{ 'selected' if request.args.get('category') == category else '' }}>
                                {{ category if category else 'Uncategorized' }}
                            </option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="col-md-3">
                        <label for="sort_by" class="form-label">Sort By</label>
                        <select class="form-select" name="sort_by" id="sort_by">
                            <option value="amount_desc" {{ 'selected' if request.args.get('sort_by') == 'amount_desc' else '' }}>Amount (High to Low)</option>
                            <option value="amount_asc" {{ 'selected' if request.args.get('sort_by') == 'amount_asc' else '' }}>Amount (Low to High)</option>
                            <option value="name_asc" {{ 'selected' if request.args.get('sort_by') == 'name_asc' else '' }}>Name (A-Z)</option>
                            <option value="name_desc" {{ 'selected' if request.args.get('sort_by') == 'name_desc' else '' }}>Name (Z-A)</option>
                            <option value="due_date" {{ 'selected' if request.args.get('sort_by') == 'due_date' else '' }}>Due Date</option>
                            <option value="interest_rate" {{ 'selected' if request.args.get('sort_by') == 'interest_rate' else '' }}>Interest Rate</option>
                        </select>
                    </div>
                    <div class="col-md-3">
                        <label for="min_amount" class="form-label">Min Amount (€)</label>
                        <input type="number" class="form-control" name="min_amount" id="min_amount" 
                               value="{{ request.args.get('min_amount', '') }}" step="0.01">
                    </div>
                    <div class="col-md-3">
                        <label for="max_amount" class="form-label">Max Amount (€)</label>
                        <input type="number" class="form-control" name="max_amount" id="max_amount" 
                               value="{{ request.args.get('max_amount', '') }}" step="0.01">
                    </div>
                    <div class="col-12">
                        <button type="submit" class="btn btn-primary me-2">
                            <i class="fas fa-search me-1"></i>Apply Filters
                        </button>
                        <a href="{{ url_for('debt') }}" class="btn btn-outline-secondary">
                            <i class="fas fa-times me-1"></i>Clear
                        </a>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- Add New Debt Section -->
<div class="row mb-4">
    <div class="col-lg-6">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="fas fa-plus me-2"></i>Add New Debt
                </h5>
            </div>
            <div class="card-body">
                <form method="POST" action="{{ url_for('add_debt') }}" 
                      data-validate="true" 
                      id="debtForm">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="debt_name" class="form-label">
                                    <i class="fas fa-tag me-1"></i>Debt Name <span class="text-danger">*</span>
                                </label>
                                <input type="text" class="form-control" id="debt_name" name="debt_name" 
                                       maxlength="21" required data-validate="maxLength:21">
                                <div class="form-text">Maximum 21 characters</div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="amount" class="form-label">
                                    <i class="fas fa-euro-sign me-1"></i>Total Amount <span class="text-danger">*</span>
                                </label>
                                <div class="input-group">
                                    <span class="input-group-text">€</span>
                                    <input type="text" class="form-control" id="amount" name="amount" 
                                           placeholder="0,00" required data-validate="amount">
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="category" class="form-label">
                                    <i class="fas fa-folder me-1"></i>Category
                                </label>
                                <input type="text" class="form-control" id="category" name="category" 
                                       placeholder="e.g., Credit Card, Loan, Medical">
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="due_date" class="form-label">
                                    <i class="fas fa-calendar me-1"></i>Due Date
                                </label>
                                <input type="date" class="form-control" id="due_date" name="due_date">
                            </div>
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="minimum_payment" class="form-label">
                                    <i class="fas fa-money-bill me-1"></i>Minimum Payment (€)
                                </label>
                                <input type="number" class="form-control" id="minimum_payment" name="minimum_payment" 
                                       step="0.01" placeholder="0.00">
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="interest_rate" class="form-label">
                                    <i class="fas fa-percentage me-1"></i>Interest Rate (%)
                                </label>
                                <input type="number" class="form-control" id="interest_rate" name="interest_rate" 
                                       step="0.01" placeholder="0.00">
                            </div>
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <label for="notes" class="form-label">
                            <i class="fas fa-sticky-note me-1"></i>Notes
                        </label>
                        <textarea class="form-control" id="notes" name="notes" rows="2" 
                                  placeholder="Additional information about this debt"></textarea>
                    </div>
                    
                    <button type="submit" class="btn btn-custom">
                        <i class="fas fa-plus me-1"></i>Add Debt
                    </button>
                </form>
            </div>
        </div>
    </div>
    
    <!-- Summary Statistics -->
    <div class="col-lg-6">
        <div class="card totals-card">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="fas fa-chart-pie me-2"></i>Summary Statistics
                </h5>
            </div>
            <div class="card-body">
                {% if statistics %}
                <div class="row mb-3">
                    <div class="col-6"><strong>Total Debts:</strong></div>
                    <div class="col-6 text-end">
                        <span class="badge bg-primary fs-6">{{ statistics.debt_count }}</span>
                    </div>
                </div>
                <div class="row mb-3">
                    <div class="col-6"><strong>Remaining:</strong></div>
                    <div class="col-6 text-end">
                        <span class="badge bg-danger fs-6">{{ format_euro(statistics.total_current) }}</span>
                    </div>
                </div>
                <div class="row mb-3">
                    <div class="col-6"><strong>Paid Off:</strong></div>
                    <div class="col-6 text-end">
                        <span class="badge bg-success fs-6">{{ format_euro(statistics.total_paid) }}</span>
                    </div>
                </div>
                <div class="row mb-3">
                    <div class="col-6"><strong>Original Total:</strong></div>
                    <div class="col-6 text-end">
                        <span class="badge bg-info fs-6">{{ format_euro(statistics.total_original) }}</span>
                    </div>
                </div>
                <div class="row mb-3">
                    <div class="col-6"><strong>Progress:</strong></div>
                    <div class="col-6 text-end">
                        <span class="badge bg-warning fs-6">{{ "%.1f"|format(statistics.progress_percent) }}%</span>
                    </div>
                </div>
                <div class="row">
                    <div class="col-6"><strong>Min. Monthly:</strong></div>
                    <div class="col-6 text-end">
                        <span class="badge bg-secondary fs-6">{{ format_euro(statistics.min_monthly) }}</span>
                    </div>
                </div>
                {% else %}
                <div class="text-center text-muted">
                    <i class="fas fa-info-circle me-2"></i>No debt data available
                </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- Debt List -->
<div class="row">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="fas fa-list me-2"></i>Debt Register
                    {% if debt_data %}
                    <span class="badge bg-primary ms-2">{{ debt_data|length }} debt(s)</span>
                    {% endif %}
                </h5>
            </div>
            <div class="card-body p-0">
                {% if debt_data %}
                <div class="table-responsive">
                    <table class="table table-dark table-striped mb-0">
                        <thead>
                            <tr>
                                <th>
                                    <input type="checkbox" id="selectAll" class="form-check-input">
                                </th>
                                <th>Name</th>
                                <th>Current Amount</th>
                                <th>Original Amount</th>
                                <th>Category</th>
                                <th>Due Date</th>
                                <th>Interest Rate</th>
                                <th>Progress</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for debt in debt_data %}
                            <tr>
                                <td>
                                    <input type="checkbox" name="debt_select" value="{{ debt.DebtName }}" class="form-check-input debt-checkbox">
                                </td>
                                <td>
                                    <strong>{{ debt.DebtName }}</strong>
                                    {% if debt.Notes %}
                                    <br><small class="text-muted">{{ debt.Notes[:50] }}{% if debt.Notes|length > 50 %}...{% endif %}</small>
                                    {% endif %}
                                </td>
                                <td>{{ format_euro(debt.Amount) }}</td>
                                <td>{{ format_euro(debt.OriginalDebt) }}</td>
                                <td>
                                    {% if debt.Category %}
                                    <span class="badge bg-secondary">{{ debt.Category }}</span>
                                    {% else %}
                                    <span class="text-muted">-</span>
                                    {% endif %}
                                </td>
                                <td>
                                    {% if debt.DueDate %}
                                    {{ debt.DueDate }}
                                    {% else %}
                                    <span class="text-muted">-</span>
                                    {% endif %}
                                </td>
                                <td>
                                    {% if debt.InterestRate %}
                                    {{ debt.InterestRate }}%
                                    {% else %}
                                    <span class="text-muted">-</span>
                                    {% endif %}
                                </td>
                                <td>
                                    {% set progress = ((debt.OriginalDebt - debt.Amount) / debt.OriginalDebt * 100) if debt.OriginalDebt > 0 else 0 %}
                                    <div class="progress" style="height: 20px;">
                                        <div class="progress-bar 
                                            {% if progress < 25 %}bg-danger
                                            {% elif progress < 75 %}bg-warning
                                            {% else %}bg-success{% endif %}" 
                                            role="progressbar" 
                                            style="width: {{ progress }}%">
                                            {{ "%.1f"|format(progress) }}%
                                        </div>
                                    </div>
                                </td>
                                <td>
                                    <div class="btn-group" role="group">
                                        <button type="button" class="btn btn-sm btn-custom" 
                                                onclick="showPaymentModal('{{ debt.DebtName }}', {{ debt.Amount }})">
                                            <i class="fas fa-money-bill"></i>
                                        </button>
                                        <a href="{{ url_for('edit_debt', debt_name=debt.DebtName) }}" 
                                           class="btn btn-sm btn-warning">
                                            <i class="fas fa-edit"></i>
                                        </a>
                                        <a href="{{ url_for('debt_log', debt_name=debt.DebtName) }}" 
                                           class="btn btn-sm btn-info">
                                            <i class="fas fa-history"></i>
                                        </a>
                                        <button type="button" class="btn btn-sm btn-danger" 
                                                onclick="confirmDelete('{{ debt.DebtName }}')">
                                            <i class="fas fa-trash"></i>
                                        </button>
                                    </div>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                {% else %}
                <div class="text-center p-4">
                    <i class="fas fa-inbox fa-3x text-muted mb-3"></i>
                    <h5 class="text-muted">No debts found</h5>
                    <p class="text-muted">Add your first debt using the form above.</p>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- Payment Modal -->
<div class="modal fade" id="paymentModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content bg-dark">
            <div class="modal-header">
                <h5 class="modal-title">Make Payment</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <form id="paymentForm" method="POST">
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="payment_amount" class="form-label">Payment Amount (€)</label>
                        <input type="number" class="form-control" id="payment_amount" name="payment_amount" 
                               step="0.01" placeholder="0.00" required>
                    </div>
                    <div class="mb-3">
                        <label for="payment_method" class="form-label">Payment Method</label>
                        <select class="form-select" id="payment_method" name="payment_method">
                            <option value="">Select method</option>
                            <option value="Bank Transfer">Bank Transfer</option>
                            <option value="Credit Card">Credit Card</option>
                            <option value="Cash">Cash</option>
                            <option value="Check">Check</option>
                            <option value="Online Payment">Online Payment</option>
                            <option value="Other">Other</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="payment_notes" class="form-label">Notes</label>
                        <textarea class="form-control" id="payment_notes" name="payment_notes" rows="2" 
                                  placeholder="Optional payment notes"></textarea>
                    </div>
                    <div class="alert alert-info">
                        <strong>Current debt amount:</strong> <span id="currentAmount"></span>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-custom">
                        <i class="fas fa-money-bill me-1"></i>Record Payment
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Bulk Payment Modal -->
<div class="modal fade" id="bulkPaymentModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content bg-dark">
            <div class="modal-header">
                <h5 class="modal-title">Bulk Payment</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <form method="POST" action="{{ url_for('bulk_pay_debts') }}">
                <div class="modal-body">
                    <p>Select debts and enter payment amounts:</p>
                    {% for debt in debt_data %}
                    <div class="row mb-2 align-items-center">
                        <div class="col-1">
                            <input type="checkbox" name="debt_names" value="{{ debt.DebtName }}" class="form-check-input">
                        </div>
                        <div class="col-5">
                            <strong>{{ debt.DebtName }}</strong><br>
                            <small class="text-muted">Current: {{ format_euro(debt.Amount) }}</small>
                        </div>
                        <div class="col-6">
                            <div class="input-group input-group-sm">
                                <span class="input-group-text">€</span>
                                <input type="number" class="form-control" name="payment_{{ debt.DebtName }}" 
                                       step="0.01" placeholder="0.00">
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-warning">
                        <i class="fas fa-money-bill-wave me-1"></i>Process Payments
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Export Modal -->
<div class="modal fade" id="exportModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content bg-dark">
            <div class="modal-header">
                <h5 class="modal-title">Export Debt Data</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <form method="POST" action="{{ url_for('export_debt_data') }}">
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="export_type" class="form-label">Export Type</label>
                        <select class="form-select" name="export_type" id="export_type" required>
                            <option value="summary">Debt Summary</option>
                            <option value="payments">Payment History</option>
                        </select>
                    </div>
                    <div class="form-text">
                        <strong>Summary:</strong> Current debt status, categories, progress<br>
                        <strong>Payment History:</strong> All payment records for all debts
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-success">
                        <i class="fas fa-download me-1"></i>Export
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Delete Confirmation Modal -->
<div class="modal fade" id="deleteModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content bg-dark">
            <div class="modal-header">
                <h5 class="modal-title">Confirm Delete</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p>Are you sure you want to delete this debt? This action cannot be undone.</p>
                <p><strong>Debt:</strong> <span id="deleteDebtName"></span></p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <form id="deleteForm" method="POST" style="display: inline;">
                    <input type="hidden" name="confirmation" value="delete">
                    <button type="submit" class="btn btn-danger">
                        <i class="fas fa-trash me-1"></i>Delete
                    </button>
                </form>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
function showPaymentModal(debtName, currentAmount) {
    const modal = new bootstrap.Modal(document.getElementById('paymentModal'));
    const form = document.getElementById('paymentForm');
    const currentAmountSpan = document.getElementById('currentAmount');
    
    form.action = `/debt/update/${debtName}`;
    currentAmountSpan.textContent = `€${currentAmount.toFixed(2)}`;
    
    modal.show();
}

function confirmDelete(debtName) {
    const modal = new bootstrap.Modal(document.getElementById('deleteModal'));
    const form = document.getElementById('deleteForm');
    const nameSpan = document.getElementById('deleteDebtName');
    
    form.action = `/debt/delete/${debtName}`;
    nameSpan.textContent = debtName;
    
    modal.show();
}

// Select All functionality
document.getElementById('selectAll').addEventListener('change', function() {
    const checkboxes = document.querySelectorAll('.debt-checkbox');
    checkboxes.forEach(checkbox => {
        checkbox.checked = this.checked;
    });
});

// Update select all when individual checkboxes change
document.querySelectorAll('.debt-checkbox').forEach(checkbox => {
    checkbox.addEventListener('change', function() {
        const allCheckboxes = document.querySelectorAll('.debt-checkbox');
        const checkedCheckboxes = document.querySelectorAll('.debt-checkbox:checked');
        const selectAllCheckbox = document.getElementById('selectAll');
        
        if (checkedCheckboxes.length === 0) {
            selectAllCheckbox.indeterminate = false;
            selectAllCheckbox.checked = false;
        } else if (checkedCheckboxes.length === allCheckboxes.length) {
            selectAllCheckbox.indeterminate = false;
            selectAllCheckbox.checked = true;
        } else {
            selectAllCheckbox.indeterminate = true;
        }
    });
});
</script>
{% endblock %}

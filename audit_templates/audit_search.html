{% extends "base.html" %}

{% block title %}Advanced Search - Audit Viewer{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <h1><i class="fas fa-search me-2"></i>Advanced Search</h1>
    <a href="/logs" class="btn btn-outline-primary">
        <i class="fas fa-list me-1"></i>
        Back to Logs
    </a>
</div>

<!-- Advanced Search Form -->
<div class="card mb-4">
    <div class="card-header">
        <h5><i class="fas fa-filter me-2"></i>Search Criteria</h5>
    </div>
    <div class="card-body">
        <form id="searchForm">
            <div class="row g-3">
                <div class="col-md-3">
                    <label for="table_name" class="form-label">Table</label>
                    <select class="form-select" id="table_name" name="table_name">
                        <option value="">All Tables</option>
                        <option value="Invoices">Invoices</option>
                        <option value="Withdraw">Withdrawals</option>
                        <option value="DebtRegister">Debt Register</option>
                        <option value="KwartaalData">Quarterly Data</option>
                        <option value="SYSTEM">System</option>
                    </select>
                </div>
                
                <div class="col-md-3">
                    <label for="action" class="form-label">Action</label>
                    <select class="form-select" id="action" name="action">
                        <option value="">All Actions</option>
                        <option value="INSERT">INSERT</option>
                        <option value="UPDATE">UPDATE</option>
                        <option value="DELETE">DELETE</option>
                        <option value="SELECT">SELECT</option>
                        <option value="TRANSACTION_START">Transaction Start</option>
                        <option value="TRANSACTION_COMPLETE">Transaction Complete</option>
                        <option value="TRANSACTION_ERROR">Transaction Error</option>
                    </select>
                </div>
                
                <div class="col-md-3">
                    <label for="record_id" class="form-label">Record ID</label>
                    <input type="text" class="form-control" id="record_id" name="record_id" 
                           placeholder="Enter record ID">
                </div>
                
                <div class="col-md-3">
                    <label for="limit" class="form-label">Result Limit</label>
                    <select class="form-select" id="limit" name="limit">
                        <option value="50">50 results</option>
                        <option value="100" selected>100 results</option>
                        <option value="250">250 results</option>
                        <option value="500">500 results</option>
                        <option value="1000">1000 results</option>
                    </select>
                </div>
            </div>
            
            <div class="row g-3 mt-2">
                <div class="col-md-3">
                    <label for="date_from" class="form-label">From Date</label>
                    <input type="datetime-local" class="form-control" id="date_from" name="date_from">
                </div>
                
                <div class="col-md-3">
                    <label for="date_to" class="form-label">To Date</label>
                    <input type="datetime-local" class="form-control" id="date_to" name="date_to">
                </div>
                
                <div class="col-md-6">
                    <label for="search_text" class="form-label">Text Search</label>
                    <input type="text" class="form-control" id="search_text" name="search_text" 
                           placeholder="Search in all fields (case-insensitive)">
                    <div class="form-text">
                        Search across all log data including changes, old values, new values, and user info.
                    </div>
                </div>
            </div>
            
            <div class="row mt-4">
                <div class="col-12">
                    <div class="d-flex gap-2">
                        <button type="submit" class="btn btn-primary">
                            <i class="fas fa-search me-1"></i>
                            Search
                        </button>
                        <button type="button" class="btn btn-outline-secondary" onclick="clearForm()">
                            <i class="fas fa-times me-1"></i>
                            Clear
                        </button>
                        <button type="button" class="btn btn-outline-info" onclick="setQuickRange(1)">
                            Today
                        </button>
                        <button type="button" class="btn btn-outline-info" onclick="setQuickRange(7)">
                            Last 7 Days
                        </button>
                        <button type="button" class="btn btn-outline-info" onclick="setQuickRange(30)">
                            Last 30 Days
                        </button>
                    </div>
                </div>
            </div>
        </form>
    </div>
</div>

<!-- Results Section -->
<div id="results" style="display: none;">
    <div class="card">
        <div class="card-header">
            <div class="d-flex justify-content-between align-items-center">
                <h5 id="resultsTitle"><i class="fas fa-list-ul me-2"></i>Search Results</h5>
                <div>
                    <button class="btn btn-sm btn-outline-success" onclick="exportResults()">
                        <i class="fas fa-download me-1"></i>
                        Export Results
                    </button>
                </div>
            </div>
        </div>
        <div class="card-body p-0">
            <div id="resultsContent">
                <!-- Results will be loaded here -->
            </div>
        </div>
    </div>
</div>

<!-- Loading Spinner -->
<div id="loading" class="text-center py-5" style="display: none;">
    <div class="spinner-border text-primary" role="status">
        <span class="visually-hidden">Loading...</span>
    </div>
    <p class="mt-2 text-muted">Searching audit logs...</p>
</div>

<!-- Saved Searches -->
<div class="card mt-4">
    <div class="card-header">
        <h5><i class="fas fa-bookmark me-2"></i>Quick Searches</h5>
    </div>
    <div class="card-body">
        <div class="row g-2">
            <div class="col-md-3">
                <button class="btn btn-outline-primary w-100" onclick="quickSearch('invoice_operations')">
                    <i class="fas fa-file-invoice me-1"></i>
                    Invoice Operations
                </button>
            </div>
            <div class="col-md-3">
                <button class="btn btn-outline-success w-100" onclick="quickSearch('recent_inserts')">
                    <i class="fas fa-plus me-1"></i>
                    Recent Inserts
                </button>
            </div>
            <div class="col-md-3">
                <button class="btn btn-outline-warning w-100" onclick="quickSearch('data_changes')">
                    <i class="fas fa-edit me-1"></i>
                    Data Changes
                </button>
            </div>
            <div class="col-md-3">
                <button class="btn btn-outline-danger w-100" onclick="quickSearch('deletions')">
                    <i class="fas fa-trash me-1"></i>
                    Deletions
                </button>
            </div>
        </div>
        
        <div class="row g-2 mt-2">
            <div class="col-md-3">
                <button class="btn btn-outline-info w-100" onclick="quickSearch('transactions')">
                    <i class="fas fa-cogs me-1"></i>
                    Transactions
                </button>
            </div>
            <div class="col-md-3">
                <button class="btn btn-outline-secondary w-100" onclick="quickSearch('errors')">
                    <i class="fas fa-exclamation-triangle me-1"></i>
                    Errors
                </button>
            </div>
            <div class="col-md-3">
                <button class="btn btn-outline-dark w-100" onclick="quickSearch('system_actions')">
                    <i class="fas fa-server me-1"></i>
                    System Actions
                </button>
            </div>
            <div class="col-md-3">
                <button class="btn btn-outline-purple w-100" onclick="quickSearch('bulk_operations')">
                    <i class="fas fa-layer-group me-1"></i>
                    Bulk Operations
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_css %}
<style>
    .btn-outline-purple {
        color: #6f42c1;
        border-color: #6f42c1;
    }
    
    .btn-outline-purple:hover {
        background-color: #6f42c1;
        border-color: #6f42c1;
        color: white;
    }
    
    .search-result-item {
        border-left: 4px solid #007bff;
        background: #f8f9fa;
        padding: 15px;
        margin-bottom: 10px;
        border-radius: 0 5px 5px 0;
    }
    
    .search-result-item.insert {
        border-left-color: #28a745;
    }
    
    .search-result-item.update {
        border-left-color: #ffc107;
    }
    
    .search-result-item.delete {
        border-left-color: #dc3545;
    }
    
    .search-result-item.select {
        border-left-color: #17a2b8;
    }
    
    .search-highlight {
        background-color: #fff3cd;
        padding: 1px 3px;
        border-radius: 2px;
    }
</style>
{% endblock %}

{% block extra_js %}
<script>
    let currentResults = [];
    
    document.getElementById('searchForm').addEventListener('submit', function(e) {
        e.preventDefault();
        performSearch();
    });
    
    function performSearch() {
        const formData = new FormData(document.getElementById('searchForm'));
        const searchData = Object.fromEntries(formData.entries());
        
        // Show loading
        document.getElementById('loading').style.display = 'block';
        document.getElementById('results').style.display = 'none';
        
        fetch('/api/search', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(searchData)
        })
        .then(response => response.json())
        .then(data => {
            displayResults(data);
            currentResults = data;
        })
        .catch(error => {
            console.error('Search failed:', error);
            alert('Search failed: ' + error.message);
        })
        .finally(() => {
            document.getElementById('loading').style.display = 'none';
        });
    }
    
    function displayResults(results) {
        const resultsContent = document.getElementById('resultsContent');
        const resultsTitle = document.getElementById('resultsTitle');
        
        resultsTitle.innerHTML = `<i class="fas fa-list-ul me-2"></i>Search Results (${results.length})`;
        
        if (results.length === 0) {
            resultsContent.innerHTML = `
                <div class="text-center py-5">
                    <i class="fas fa-search fa-3x text-muted mb-3"></i>
                    <h5 class="text-muted">No results found</h5>
                    <p class="text-muted">Try adjusting your search criteria.</p>
                </div>
            `;
        } else {
            let html = '<div class="table-responsive"><table class="table table-hover mb-0">';
            html += `
                <thead class="table-light">
                    <tr>
                        <th>Timestamp</th>
                        <th>Action</th>
                        <th>Table</th>
                        <th>Record ID</th>
                        <th>Changes</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
            `;
            
            results.forEach((log, index) => {
                const actionClass = log.action.toLowerCase().replace('_', '');
                const badgeClass = log.action === 'INSERT' ? 'success' : 
                                 log.action === 'UPDATE' ? 'warning' : 
                                 log.action === 'DELETE' ? 'danger' : 
                                 log.action === 'SELECT' ? 'info' : 'primary';
                
                html += `
                    <tr class="search-result-item ${actionClass}">
                        <td class="timestamp small">${log.timestamp}</td>
                        <td>
                            <span class="badge bg-${badgeClass}">${log.action}</span>
                        </td>
                        <td>
                            <a href="/logs?table=${log.table_name}" class="text-decoration-none fw-bold">
                                ${log.table_name}
                            </a>
                        </td>
                        <td>
                            <a href="/record/${log.table_name}/${log.record_id}" class="text-decoration-none">
                                <code>${log.record_id}</code>
                            </a>
                        </td>
                        <td>
                            ${formatChanges(log, index)}
                        </td>
                        <td>
                            <div class="btn-group btn-group-sm">
                                <a href="/record/${log.table_name}/${log.record_id}" 
                                   class="btn btn-outline-primary btn-sm" title="View History">
                                    <i class="fas fa-history"></i>
                                </a>
                                <button class="btn btn-outline-secondary btn-sm" 
                                        onclick="copyToClipboard('${log.id}')" title="Copy Log ID">
                                    <i class="fas fa-copy"></i>
                                </button>
                            </div>
                        </td>
                    </tr>
                `;
            });
            
            html += '</tbody></table></div>';
            resultsContent.innerHTML = html;
        }
        
        document.getElementById('results').style.display = 'block';
    }
    
    function formatChanges(log, index) {
        if (log.changes && Object.keys(log.changes).length > 0) {
            return `
                <button class="btn btn-sm btn-outline-info" onclick="toggleJSON('search-changes-${index}')">
                    <i class="fas fa-eye me-1"></i>
                    ${Object.keys(log.changes).length} changes
                </button>
                <div id="search-changes-${index}" style="display: none;" class="mt-2">
                    ${Object.entries(log.changes).map(([field, change]) => `
                        <div class="change-item mb-1">
                            <strong>${field}:</strong>
                            <span class="old-value">${change.old}</span>
                            →
                            <span class="new-value">${change.new}</span>
                        </div>
                    `).join('')}
                </div>
            `;
        } else if (log.old_values || log.new_values) {
            return '<span class="badge bg-secondary">Data Available</span>';
        } else {
            return '<span class="text-muted">-</span>';
        }
    }
    
    function clearForm() {
        document.getElementById('searchForm').reset();
        document.getElementById('results').style.display = 'none';
        currentResults = [];
    }
    
    function setQuickRange(days) {
        const now = new Date();
        const fromDate = new Date(now.getTime() - (days - 1) * 24 * 60 * 60 * 1000);
        
        document.getElementById('date_from').value = fromDate.toISOString().slice(0, 16);
        document.getElementById('date_to').value = now.toISOString().slice(0, 16);
    }
    
    function quickSearch(type) {
        clearForm();
        
        switch (type) {
            case 'invoice_operations':
                document.getElementById('table_name').value = 'Invoices';
                break;
            case 'recent_inserts':
                document.getElementById('action').value = 'INSERT';
                setQuickRange(7);
                break;
            case 'data_changes':
                document.getElementById('action').value = 'UPDATE';
                setQuickRange(30);
                break;
            case 'deletions':
                document.getElementById('action').value = 'DELETE';
                break;
            case 'transactions':
                document.getElementById('search_text').value = 'TRANSACTION';
                break;
            case 'errors':
                document.getElementById('search_text').value = 'ERROR';
                break;
            case 'system_actions':
                document.getElementById('table_name').value = 'SYSTEM';
                break;
            case 'bulk_operations':
                document.getElementById('search_text').value = 'bulk';
                break;
        }
        
        performSearch();
    }
    
    function exportResults() {
        if (currentResults.length === 0) {
            alert('No results to export');
            return;
        }
        
        const blob = new Blob([JSON.stringify(currentResults, null, 2)], {
            type: 'application/json'
        });
        
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `audit_search_results_${new Date().toISOString().slice(0, 10)}.json`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
    }
    
    // Initialize with current date/time
    document.addEventListener('DOMContentLoaded', function() {
        setQuickRange(7); // Default to last 7 days
    });
</script>
{% endblock %}
